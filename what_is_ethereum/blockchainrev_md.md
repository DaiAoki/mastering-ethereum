## ブロックチェーン革命

### 中央機関の存在しない通貨：ビットコイン

2008年のNakamoto氏による論文「Bitcoin: A Peer-to-Peer Electronic Cash System」の発表と、その後の有志によるビットコインの開発は、通貨の世界に革新を起こしました。

ビットコインを利用するためのソフトはオープンソースで提供され、PCからスマートフォンまで様々なデバイス上で動作し、ユーザーはネットワークを通じてビットコインをやり取りすることで、従来の通貨で行うほぼ全てのこと、つまり物品の売買から個人や組織への送金、融資まで行うことが可能になです。ビットコインは海外への送金も非常に高速かつ安全で低コストで可能であることから通貨の理想形と考えれられています。

このような通貨としての利便性はもちろんですが、ビットコインの最も重要な革新性は、従来の（電子マネーを含む）通貨とは異なり、通貨発行や取引合意そして決済に、いかなる中央機関や管理者も必要としないP2Pの通貨システムであることにあります。

Nakamoto氏の論文は「ビザンチン将軍問題」と呼ばれる分散コンピューティングの分野での難問に、初めて実用的な解を与えるものでした。

「ビザンチン将軍問題」とは、不特定多数のノードで構成され潜在的に悪意のあるノードも含まれるようなP2Pネットワークの中で、各ノードの情報交換により、通貨の取引情報（例えば誰から誰にいくら支払った等）にネットワーク全体で合意を形成することは可能か？可能である場合はどのように行えばよいのか？という問題です。

P2Pは不特定多数のノードがランダムに接続されたネットワークです。例えば、P2Pのネットワーク内で悪意のあるノードが自身は$100だけ保持しているにもかかわらず、$100をAに送金したという情報をそのノードに繋がっているノードの一つに送り、同時に同じ$100をBに送金したいう情報を別のノードに送信したとしたらどうなるでしょう（二重支払問題）。それぞれの情報を受け取ったノードがそれらの情報を信じて動作すると、ネットワーク内の資金の流れの情報に整合性が無くなり、たちまちこの通貨システムは破たんしてしまいます。

Nakamoto氏はブロックチェーンとプルーフ・オブ・ワークという仕組みを導入することで、P2Pのシステム上で通貨システム実現しようとする際に生まれるこの問題を、解決することに成功しました。次節以降で、ビットコインの動作の概略とともに、どのように解決したのかについて見ていきましょう。

###ビットコインでの送金の仕組み

技術的には、ビットコインの世界では、実際に何らかの電子的なコインが存在しそれをやり取りしているわけでは*ありません*。「送信者から受信者へある一定量の額面を移動させる」という取引（トランザクション）の中で各ユーザーのビットコインの保有額が暗に示されるものです。

つまり、あるユーザー（のアドレス）が保持するビットコインの量は、その時点より以前に発生した太郎に向けて支払われたトランザクションのうち、まだ他の誰かに支払うために使われていないトランザクション（UTXO: Unspent Transaction Output ）を寄せ集め、そのそれぞれのUTXOの額面の総和になります。

例えば、太郎は以前に、友人Aから 10 BTC、友人Bから 20 BTC のビットコインをもらったとします。そうすると太郎が所有権をもつ２つのUTXOがその時点で生成されており、その総額が 30 BTCなので、太郎はビットコイン30 BTC を保有している、ということになります。

さて、ここで太郎が花子に 25 BTC を送金したいとするとどうなるでしょうか？
UTXO自体はトランザクションの情報なので、その額面を分割することはできません。そのため太郎は「自分の持っている２つのUTXO （計 30 BTC）を使って、25 BTC を花子のアドレスに、5 BTC を *自分自身のアドレスに* 送る」という新しいトランザクションを生成します。これにより花子と太郎はそれぞれ 25 BTC、5 BTC のUTXOを新たに得ることになります。これは現実世界で950円支払うのに千円札で支払い、50円のお釣りを受け取ることに似ています。

###ブロックチェーン

従来のように中央管理機関が存在している通貨システムであれば、太郎は自ら生成したトランザクションの情報をその中央機関に送信し、その機関は受信したトランザクションの情報に基づいて、自ら管理する取引台帳にその情報を更新すればよいだけです。

システムの参加者は、この信用に足る中央機関の管理する台帳が「正」であると皆で「合意」することができます。また、たとえ太郎に悪意があって、花子に 25 BTC を送った後に同じUTXOを使って 25BTC 別の人に送ろうとしても、中央機関はそのUTXOは使用済みと知っているので、「使えない」とすればよいだけで、非常にシンプルです。

一方、P2Pのシステムであるビットコインは、代表して台帳を管理する機関（システム）が存在しません。そのため、各ノードが「ブロックチェーン」と呼ばれる取引台帳を共有し、その台帳を「正」とする合意をとります。

ビットコインのシステムでは「採掘者」と呼ばれるノードが、ある時点からある時点までの間に行われたトランザクションの情報を1つの「ブロック」と呼ばれるパッケージにまとめる「採掘」という作業を行います。そのブロックには、前に作成されたブロックへの参照（ブロックヘッダのHash値）を含めることで、そのブロックが時系列に連なった一本のチェーン（ブロックチェーン）が連なっていきます。このブロックチェーンには、ビットコインが始まって以来の全てのトランザクション情報が含まれており、公開取引台帳の役割を果たします。

「採掘者」はブロックを生成時、
* UTXOの所有者以外が、そのUTXOを用いて送金を行っていないか？
* 同じUTXOを複数回使用するようなトランザクションがないか？

といった、ブロックに含めるトランザクションの正当性を確認してブロック生成します。
また、その「採掘者」生成したブロックを他のノードが受け取った際にも同様の確認をし、新しいブロックが追加されたブロックチェーンを「正」として合意するという仕組みで、取引台帳としてのブロックチェーンの正当性を合意していく仕組みをとっています。

###プルーフ・オブ・ワーク
さて、P2Pシステムの性質上、ここでブロックを生成する「採掘者」は特別な権限を与えられな参加者ではなく、任意の参加者が「採掘者」になることが可能です。しかし一方で、誰でも何の制限もなくブロックが生成できるとなると、皆が好き勝手にブロックチェーンを連ねていき、どのブロックチェーンが皆が合意する「正」のブロックチェーンかが分からなくなる事態になります。

そこでビットコインでは、「プルーフ・オブ・ワーク」という仕組みを導入します。これは生成するブロックのSHA256ハッシュ値が、その先頭に一定の数以上の0が並ばなければならないという制限です。この制限を満たすために、採掘者はnonce（ノンス）と呼ばれる付加データをブロックに追加することで、ハッシュ値の先頭に0が並ぶように調整を行います。SHA256のような暗号学的ハッシュ関数は、出力されるハッシュ値が元のデータからは予見できないように設計されている関数のために、採掘者は、一定個の数のゼロが並ぶハッシュ関数が出力されるまで、ナンスの値を変更しながら試行錯誤をするしか手はありません。
採掘者は、一定の0が並ぶハッシュ値を生むノンスを見つけ出した（＝ブロックの採掘に成功した）ら、その情報をビットコイン・ネットワーク内に発信し、それを受信した他の参加者はブロックの内容を確認、問題がないことが分かればそのブロックが「正」として合意します。

採掘に成功したノードには、インセンティブとして25 BTC の報酬が与えられます。ビットコイン・ネットワークには、多数の採掘者が存在し、報酬を得るために、常に採掘競争を行っています。

プルーフオブワークの制限は、ネットワーク全体で「採掘者」達が10分に１回程度の頻度でその条件に合うハッシュ値を生成するノンスを見つけ、新しいブロック採掘できる程度に動的に調整されます。

###２重支払問題の解決
このブロックチェーンとプルーフオブワークの組み合わせにより、悪意のある参加者（攻撃者）が２重支払を行うことを防ぐことが可能になります。少し具体的に見てみましょう。攻撃者が以下のような方法で２重支払いを利用し商品をだまし取ろうとした場合のケースを考えましょう。
1. A氏が、あるEC業者から商品を購入し100BTCを送金する。
2. EC業者は100BTCが送金されたことをブロックチェーンの記録を見て確認する。送金されたことが確認できたら、商品を発送する。
3. A氏が商品を受け取る。
4. A氏が業者に支払った100BTCをなかったことにするために、同じ100BTCを自分自身に送金したというように、ブロックチェーンを書き換える。

ステップ１の送金の事実が、ここでは仮にブロック番号2000番のブロックに記録されていたとします。ブロックが生成され、ネットワークがそれを受け入れた時点（他の採掘者がそのブロックに連なる次のブロックを採掘し始めた時点）でビットコイン・ネットワーク内で「A氏からEC業者への100BTCの送金した」という事実が存在するという、合意が得られたことになります。A氏がブロックチェーンを書き換えてこの事実を亡き者としようとする場合、このブロック番号2000のブロックを「自分自身に送金した」というように書き換える必要があります。トランザクションの中身が変わっているために既に存在するブロック番号2000のハッシュ値も替るため、A氏はこの書き換えたトランザクションの内容で番号2000のブックを再び採掘する必要があります。また、採掘しなおしたブロックはオリジナルのブロックとは異なるハッシュ値を持っているため、他の採掘者が採掘した2001以降のブロックはもはやA氏が書き換えたブロックの方は参照しません。ビットコインのブロックチェーンのルールとして、Forkができた場合は、最も長いForkを生とするというルールがあるため、A氏が2,000番のブロックを採掘したとしても他の採掘者はそれに連なるブロックを採掘しようとはせず、正当な方の分岐の採掘を行おうとします。一方でA氏は、自分のみで270000チェインに続くブロックを採掘していこうとするのですが、攻撃者が自分のブロックチェインを最も長くするためには、彼はキャッチアップするためには残りのネットワーク全部の計算パワーを上回る必要があります。ビットコイン・ネットワークに十分な採掘者が参加していれば、A氏単独で残りの採掘者達の計算パワーには勝つことは容易ではありません。（A氏が単独で全採掘者の計算パワーの51%を占める必要があります。）そのため、２縦走金が出来ない仕組みとなっているのです。

### ビットコインの応用例とその問題