## トランザクションの構築

Aliceのウォレット・アプリケーションは、Aliceが行おうとするトランザクションに必要なインプットを自動的に集めアウトプットを構成するためのロジックが組み込まれています。そのためAliceは送金先とその送金額だけ指定すればよく、その他に必要な処理はアプリケーションの中で自動的に行ってくれます。重要なこととして、トランザクションはアプリケーションがネットワークに繋がっていない時にも構成可能ということが挙げられます。家にいる時に小切手に必要事項を書いて封書で銀行に郵送できるように、ビットコインのトランザクションの構築と送金の承認はネットワークに繋がっていない状態でも可能であり、その後ネットワークに接続された際に送金を実行することが可能です。

### 適切なインプットを集める
Aliceのウォレット・アプリケーションは、まず最初にBobに支払う額に足るインプットを探さなければなりません。ほとんどのウォレット・アプリケーションは、そのウォレット自身の秘密鍵によってロック（解除制限）されている未使用のトランザクション・アウトプット（UTXO:Unspent Transaction Output）を管理するための小さなデータベースを持っています。そのためAliceのウォレットにはJoeから現金と引き換えにビットコインを受け取った（＜最初のビットコインを手に入れる＞節参照）トランザクション・アウトプットの情報が保持されています。. ウォレット・アプリケーションの中にはネットワーク上の全ての未使用のトランザクション・アウトプットを保持するものもあり、受信した任意のトランザクションが正当なインプットを元に構成されているのかを素早く検証することもできます。しかしこのようなクライアントは非常に大きなデータ容量を使用するため、一般的なユーザーは自身の未使用トランザクション・アウトプットのみを管理する「軽量クライアント」を使います。

ウォレットがUTXOを管理していない場合でも、様々なAPIを通じてプロバイダに問い合わせたり、bitcoin JSON RPC APIを用いてフル・インデックス・ノードに問い合わせることで情報を得ることができます。例2-1では、特定のURLへの HTTP GET コマンドとして RESTfulなAPIへのリクエストを送る例を示しています。このURLは、あるアドレスの未使用トランザクション・アウトプットを返すものです。ここではレスポンスを受け取るために、コマンド _cURL_を使います。

例2-1： Aliceのビットコイン・アドレスが持つUTXOの検索
```
$ curl https://blockchain.info/unspent?active=1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK
```

例2-2： 検索に対するレスポンス
```
{
    "unspent_outputs":[
        {
            "tx_hash":"186f9f998a5...2836dd734d2804fe65fa35779",
            "tx_index":104810202,
            "tx_output_n": 0,
            "script":"76a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac",
            "value": 10000000,
            "value_hex": "00989680",
            "confirmations":0
        }
    ]
}
```

例2-2のレスポンス結果には、Aliceのアドレス（`1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK`）がオーナーの１つのUTXOがあります。またそのアウトプットが生まれたJoeからの支払いに関するトランザクションの情報も含まれ、支払額の 0.10 bitcoin が satoshiの単位で記載されています（1,000万 satoshi）。この情報をもとにAliceのウォレット・アプリケーションは新しいオーナーへビットコインを送金するためのトランザクションを構築することになります。

---
**【TIP】**
JoeからAliceへのトランザクション情報は[こちら](http://bit.ly/1tAeeGr) で参照可能。

---

今回の例では、Aliceのウォレットにコーヒー代に足る額の１つの未使用トランザクション・アウトプットが有りました。もし１つのアウトプットで足りない場合には、財布から小銭をかき集めるように、ウォレット・アプリケーションは少額の未使用トランザクション・アウトプットをかき集めてコーヒー代を払うためのインプットを構成します。どちらのケースにしろ、ウォレット・アプリケーションはトランザクションを生成するために、トランザクション・アウトプットを構築し、お釣をもらう処理が必要になります。次の節ではその様子を見ていきます。

### アウトプットを作成する

トランザクション・アウトプットは、その額面に対して解除条件を課し、解除条件を満たす解を与えないとその額面を利用できないようなスクリプトの形態をとります。簡単にいうと「このアウトプットはBobのアドレスに紐づく秘密鍵を提示した者に限り利用できる」というようなものです。BobだけがBobのアドレスに紐づく秘密鍵を持つので、Bobのウォレット・アプリケーションだけが、そのアウトプットを利用することができます。AliceはBobに支払うトランザクションを構築する際に、Bobの秘密鍵を解除条件とするアウトプットを生成するのです。

今回のトランザクションではもう一つのアウトプットが必要になります。Aliceの利用しようとしている未使用トランザクション・アウトプットは 0.10BTC のものであり、0.015BTC のコーヒー代金よりも大きいものなので、Aliceは0.085BTCのお釣りを受け取る必要があります。Aliceへのお釣りの支払いはBobへの支払いと同様に、*Aliceのウォレットが* 生成します。Aliceのウォレットは元の未使用トランザクション・アウトプットを２つの支払いに分解し、一つをBobに、もう一つをAlice自身に支払うことで、お釣りの額面はAlice自身が利用できるようにするのです。

最後に、このトランザクションが素早くネットワーク上で処理されるように、Aliceのウォレット・アプリケーションは若干の手数料を加算します。この手数料はトランザクションの中で明示的には示されず、トランザクション中のインプットとアウトプットの差額がそれになります。0.085 BTCのお釣りのアウトプットの代わりに、0.0845 BTCをアウトプットを生成すると0.0005 BTC（0.5 millibitcoin）が元のインプットの額との差額として残ります。この差額分が、このトランザクションをブロックに組み込み最終的にブロックチェーンの元帳に記録するためのトランザクション手数料として採掘者に徴収されることになります。

今回生成されたトランザクションは、ブロックチェーン・エクスプローラを使うと下図のように見ることができます。

!["アリスからBobのカフェへの支払いのトランザクション"](00_images/msbt_0208.png "アリスからBobのカフェへの支払いのトランザクション")

---
**【TIP】**
AliceからBobのカフェへのトランザクション情報は[こちら](http://bit.ly/1u0FIGs) で参照可能。

---

### トランザクションを元帳に記録する

Aliceによって生成されたトランザクションの情報には、元の所有者の確認や新しい所有者の指定に必要な情報が入っており、258バイトのデータになります。このトランザクションのデータが分散型元帳（ブロックチェーン）に記録されるために、ビットコイン・ネットワークへデータが転送されなくてはいけません。次の節では、トランザクションの情報がどのようにブロックに組み込まれ、そのブロックがどのように採掘されるのかを見ていきます。また、ブロックチェーンにより多くのブロックが追加されていくにしたがって、追加されたブロックの情報の信頼性が高まっていく様子を見ていきます。

####トランザクションの転送
トランザクション情報には処理に必要な情報がすべて含まれるため、その情報がビットコイン・ネットワークのどこに、どのように転送されるかは考える必要はありません。ビットコイン・ネットワークはその参加クライアントがいくつかのクライアントに接続しているP2Pネットワークの形体を取っており、トランザクションやブロックの情報を全てのネットワーク参加ノードに伝搬する役割を担います。

#### トランザクションの伝搬
Aliceのウォレット・アプリケーションは有線・WiFi・モバイルなど任意の接続方法で、今回の新しいトランザクション情報を任意のビットコイン・クライアントに送信します。Bobのビットコイン・クライアントに直接接続する必要もなければ、店内のネットワークを使う必要もありません（もちろんそうすることもできますが）。 ビットコイン・ネットワーク上の任意のノードは新しい有効なトランザクション情報を受信すると、即時にそのノードに接続されている他のノードに転送します。これにより、P2Pネットワーク上の大半のノードに数秒以内にトランザクション情報が行き渡ることになります。

#### Bobから見ると
Bobのウォレット・アプリケーションがAliceのものに直接接続していた場合、Bobがトランザクション情報を受信する最初のクライアントになるかもしれません。しかし、たとえそうでなくても、BobはAliceからのトランザクション情報を他のノードを介して数秒以内に受け取ります。Bobのウォレットはトランザクション内に自分の鍵で解除可能であるアウトプットが存在するのを見て自分への支払としてと認識できます。Bobのウォレット・アプリケーションは、そのアウトプットが以前に利用されていないか、次のブロックに組み込んでもらえるだけの十分なトランザクション手数料が含まれているのかを確認します。この時点でBobはこのトランザクションがブロックに組み込まれ承認されることをある程度確認できます。